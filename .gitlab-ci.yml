stages:
  - deploy
  - test
  - merge

deploy_homol:
  stage: deploy
  image: node
  before_script:
    - apt update > /dev/null 2>&1 
    - apt install dos2unix python3 python3-pip jq git unzip zip curl bash openssl wget rsync -y > /dev/null 2>&1
    - DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends tzdata > /dev/null 2>&1
    - rm -rf /etc/localtime
    - ln -s /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime
    - date
    - curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - unzip -q awscliv2.zip
    - ./aws/install
    - aws --version
    - DATE=$(date +%d-%m-%YH%H:%M:%S)
    - echo $DATE
    - 'which ssh-agent || ( apt-get install -qq openssh-client )'
    - eval $(ssh-agent -s)
    # Setup SSH deploy keys
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    - export AWS_ACCESS_KEY_ID="${HOMOL_AWS_ACCESS_KEY_ID}"
    - export AWS_SECRET_ACCESS_KEY="${HOMOL_AWS_SECRET_ACCESS_KEY}"
  script:
    - echo "Buscando servidor do servico $CI_PROJECT_NAME no ambiente homol"
    - INSTANCE_NAME=$(aws ec2 describe-instances --region $AWS_DEFAULT_REGION --filters "Name=tag:Name,Values=$CI_PROJECT_NAME*" --query 'Reservations[*].Instances[*].{Name:Tags[?Key==`Name`]|[0].Value,PrivateIP:PrivateIpAddress}' | jq '.[] | .[] | .Name')
    - INSTANCE_NAME=`echo $INSTANCE_NAME | cut -d '"' -f2`
    - SERVER_IP=$(aws ec2 describe-instances --region $AWS_DEFAULT_REGION --filters "Name=tag:Name,Values=$CI_PROJECT_NAME*" --query 'Reservations[*].Instances[*].{Name:Tags[?Key==`Name`]|[0].Value,PrivateIP:PrivateIpAddress}' | jq '.[] | .[] | .PrivateIP')
    - SERVER_IP=`echo $SERVER_IP | cut -d '"' -f2`
    - echo "Iniciando deploy do serviço $CI_PROJECT_NAME no servidor Nome=$INSTANCE_NAME | IP=$SERVER_IP"
    - cp $ENV_HOMOL .env
    - ssh ubuntu@$SERVER_IP "sudo rm -rf /srv/$CI_PROJECT_NAME"
    - ssh ubuntu@$SERVER_IP "sudo mkdir -p /srv/$CI_PROJECT_NAME"
    - ssh ubuntu@$SERVER_IP "sudo chown -R ubuntu:ubuntu /srv/$CI_PROJECT_NAME"
    - ssh ubuntu@$SERVER_IP 'export PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin; pm2 show '${CI_PROJECT_NAME}'; if [ $? -eq 0 ]; then pm2 delete all; else echo "Nenhum processo encontrado" ; fi'
    - rsync -azvr ../$CI_PROJECT_NAME/* --exclude=aws --exclude=awscliv2.zip --exclude=.git ubuntu@$SERVER_IP:/srv/$CI_PROJECT_NAME/
    - rsync -azvr .env ubuntu@$SERVER_IP:/srv/$CI_PROJECT_NAME/
    - ssh ubuntu@$SERVER_IP "export PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin; cd /srv/$CI_PROJECT_NAME; npm install ; npm run migrate:latest"
    - ssh ubuntu@$SERVER_IP "export PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin; cd /srv/$CI_PROJECT_NAME; pm2 start -f src/index.js --name $CI_PROJECT_NAME --log-date-format='DD-MM-YYYY HH:mm Z' --log-type json"  
    - ssh ubuntu@$SERVER_IP "sudo env PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin /usr/local/nvm/versions/node/v10.14.1/lib/node_modules/pm2/bin/pm2 startup systemd -u ubuntu --hp /home/ubuntu"
    - ssh ubuntu@$SERVER_IP "sudo systemctl enable pm2-ubuntu"
    - ssh ubuntu@$SERVER_IP "export PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin; pm2 save"
    - ssh ubuntu@$SERVER_IP "sudo env PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin pm2 logrotate -u ubuntu"
    - ssh ubuntu@$SERVER_IP "export PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin; pm2 set pm2-logrotate:max_size 100M ; pm2 set pm2-logrotate:retain 10 ; pm2 set pm2-logrotate:compress true"
  only:
    - homol
  when: on_success
  allow_failure: false


test_homol:
  stage: test
  image: node
  before_script:
    - apt update > /dev/null 2>&1 
    - apt install dos2unix python3 python3-pip jq git unzip zip curl bash openssl wget rsync -y > /dev/null 2>&1
    - DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends tzdata > /dev/null 2>&1
    - rm -rf /etc/localtime
    - ln -s /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime
    - date
    - curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - unzip -q awscliv2.zip
    - ./aws/install
    - aws --version
    - DATE=$(date +%d-%m-%YH%H:%M:%S)
    - echo $DATE
    - 'which ssh-agent || ( apt-get install -qq openssh-client )'
    - eval $(ssh-agent -s)
    # Setup SSH deploy keys
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    - export AWS_ACCESS_KEY_ID="${HOMOL_AWS_ACCESS_KEY_ID}"
    - export AWS_SECRET_ACCESS_KEY="${HOMOL_AWS_SECRET_ACCESS_KEY}"
  script:
    - echo "Buscando servidor do servico $CI_PROJECT_NAME no ambiente homol"
    - INSTANCE_NAME=$(aws ec2 describe-instances --region $AWS_DEFAULT_REGION --filters "Name=tag:Name,Values=$CI_PROJECT_NAME*" --query 'Reservations[*].Instances[*].{Name:Tags[?Key==`Name`]|[0].Value,PrivateIP:PrivateIpAddress}' | jq '.[] | .[] | .Name')
    - INSTANCE_NAME=`echo $INSTANCE_NAME | cut -d '"' -f2`
    - SERVER_IP=$(aws ec2 describe-instances --region $AWS_DEFAULT_REGION --filters "Name=tag:Name,Values=$CI_PROJECT_NAME*" --query 'Reservations[*].Instances[*].{Name:Tags[?Key==`Name`]|[0].Value,PrivateIP:PrivateIpAddress}' | jq '.[] | .[] | .PrivateIP')
    - SERVER_IP=`echo $SERVER_IP | cut -d '"' -f2`
    - echo "Listando processos em execução para o projeto $CI_PROJECT_NAME no ambiente homol"
    - ssh ubuntu@$SERVER_IP "export PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin; pm2 show '${CI_PROJECT_NAME}'"
    - echo "Verificando resposta do healthcheck localhost"
    - ssh ubuntu@$SERVER_IP "curl -s -I -X GET http://localhost:5000/api/v1/health"
    - echo "Verificando status code do healthcheck localhost"
    - curl -s -I -X GET http://$SERVER_IP:5000/api/v1/health
    - STATUS_CODE=`curl -s -I -X GET http://$SERVER_IP:5000/api/v1/health | grep HTTP | awk '{print $2}'`
    - echo $STATUS_CODE
    - >
            if [[ "$STATUS_CODE" == "200" ]]; 
            then 
                echo "O aplicativo '${CI_PROJECT_NAME}' esta esta respondendo status code  $STATUS_CODE"
                exit 0
            else 
                echo "O aplicativo '${CI_PROJECT_NAME}' esta esta respondendo status code de error  $STATUS_CODE"
                exit 1
            fi
  only:
    - homol
  when: on_success
  allow_failure: true


SolicitaMR:
  stage: merge
  image: node
  before_script:
    - apt update > /dev/null 2>&1
    - apt install dos2unix python3 python3-pip jq git unzip zip curl bash openssl wget rsync -y > /dev/null 2>&1
    - DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends tzdata > /dev/null 2>&1
    - rm -rf /etc/localtime
    - ln -s /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime
    - date
    - curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - unzip -q awscliv2.zip
    - ./aws/install
    - aws --version
    - DATE=$(date +%d-%m-%YH%H:%M:%S)
    - echo $DATE
    - 'which ssh-agent || ( apt-get install -qq openssh-client )'
    - eval $(ssh-agent -s)
    # Setup SSH deploy keys
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    - export AUTOMACAO_TOKEN="${AUTOMACAO_TOKEN}"
  script:
    - >
      wget --header='PRIVATE-TOKEN: '${AUTOMACAO_TOKEN}'' 'https://gitlab.com/api/v4/projects/24070595/repository/files/auto_merge_request.sh/raw?ref=master' -O auto_merge_request.sh
    - chmod +x auto_merge_request.sh
    - HOST=${CI_PROJECT_URL} CI_PROJECT_ID=${CI_PROJECT_ID} CI_COMMIT_REF_NAME=${CI_COMMIT_REF_NAME} GITLAB_USER_ID=${GITLAB_USER_ID} PRIVATE_TOKEN=${AUTOMACAO_TOKEN} ./auto_merge_request.sh
  only:
    - homol
  when: manual
  allow_failure: true

deploy_prod:
  stage: deploy
  image: node
  before_script:
    - apt update > /dev/null 2>&1 
    - apt install dos2unix python3 python3-pip jq git unzip zip curl bash openssl wget rsync -y > /dev/null 2>&1
    - DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends tzdata > /dev/null 2>&1
    - rm -rf /etc/localtime
    - ln -s /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime
    - date
    - curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - unzip -q awscliv2.zip
    - ./aws/install
    - aws --version
    - DATE=$(date +%d-%m-%YH%H:%M:%S)
    - echo $DATE
    - 'which ssh-agent || ( apt-get install -qq openssh-client )'
    - eval $(ssh-agent -s)
    # Setup SSH deploy keys
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    - export AWS_ACCESS_KEY_ID="${PROD_AWS_ACCESS_KEY_ID}"
    - export AWS_SECRET_ACCESS_KEY="${PROD_AWS_SECRET_ACCESS_KEY}"
  script:
    - echo "Buscando servidor do servico $CI_PROJECT_NAME no ambiente prod"
    - INSTANCE_NAME=$(aws ec2 describe-instances --region $AWS_DEFAULT_REGION --filters "Name=tag:Name,Values=$CI_PROJECT_NAME*" --query 'Reservations[*].Instances[*].{Name:Tags[?Key==`Name`]|[0].Value,PrivateIP:PrivateIpAddress}' | jq '.[] | .[] | .Name')
    - INSTANCE_NAME=`echo $INSTANCE_NAME | cut -d '"' -f2`
    - SERVER_IP=$(aws ec2 describe-instances --region $AWS_DEFAULT_REGION --filters "Name=tag:Name,Values=$CI_PROJECT_NAME*" --query 'Reservations[*].Instances[*].{Name:Tags[?Key==`Name`]|[0].Value,PrivateIP:PrivateIpAddress}' | jq '.[] | .[] | .PrivateIP')
    - SERVER_IP=`echo $SERVER_IP | cut -d '"' -f2`
    - echo "Ativando downtime de 10m para o servidor $INSTANCE_NAME no monitoramento"
    - curl -I -s "http://${CHECKMK_HOST}/check_mk/view.py?_username=${CHECKMK_USER}&_secret=${CHECKMK_SECRET}&_transid=-1&_do_confirm=yes&_do_actions=yes&host=${INSTANCE_NAME}&_down_from_now=yes&_down_minutes=5&_down_comment=Deploy_Aplicacao&view_name=hoststatus"
    - echo "Iniciando deploy do serviço $CI_PROJECT_NAME no servidor Nome=$INSTANCE_NAME | IP=$SERVER_IP"
    - cp $ENV_PROD .env
    - ssh ubuntu@$SERVER_IP "sudo rm -rf /srv/$CI_PROJECT_NAME"
    - ssh ubuntu@$SERVER_IP "sudo mkdir -p /srv/$CI_PROJECT_NAME"
    - ssh ubuntu@$SERVER_IP "sudo chown -R ubuntu:ubuntu /srv/$CI_PROJECT_NAME"
    - ssh ubuntu@$SERVER_IP 'export PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin; pm2 show '${CI_PROJECT_NAME}'; if [ $? -eq 0 ]; then pm2 delete all; else echo "Nenhum processo encontrado" ; fi'
    - rsync -azvr ../$CI_PROJECT_NAME/* --exclude=aws --exclude=awscliv2.zip --exclude=.git ubuntu@$SERVER_IP:/srv/$CI_PROJECT_NAME/
    - rsync -azvr .env ubuntu@$SERVER_IP:/srv/$CI_PROJECT_NAME/
    - ssh ubuntu@$SERVER_IP "export PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin; cd /srv/$CI_PROJECT_NAME; npm install ; npm run migrate:latest"
    - ssh ubuntu@$SERVER_IP "export PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin; cd /srv/$CI_PROJECT_NAME; pm2 start -f src/index.js --name $CI_PROJECT_NAME --log-date-format='DD-MM-YYYY HH:mm Z' --log-type json"  
    - ssh ubuntu@$SERVER_IP "sudo env PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin /usr/local/nvm/versions/node/v10.14.1/lib/node_modules/pm2/bin/pm2 startup systemd -u ubuntu --hp /home/ubuntu"
    - ssh ubuntu@$SERVER_IP "sudo systemctl enable pm2-ubuntu"
    - ssh ubuntu@$SERVER_IP "export PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin; pm2 save"
    - ssh ubuntu@$SERVER_IP "sudo env PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin pm2 logrotate -u ubuntu"
    - ssh ubuntu@$SERVER_IP "export PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin; pm2 set pm2-logrotate:max_size 100M ; pm2 set pm2-logrotate:retain 10 ; pm2 set pm2-logrotate:compress true"
    - echo "Removendo downtime do servidor $INSTANCE_NAME no monitoramento"
    - curl -I -s "http://${CHECKMK_HOST}/check_mk/view.py?_do_confirm&_transid=-1&_do_actions=yes&_username=${CHECKMK_USER}&_secret=${CHECKMK_SECRET}&view_name=hoststatus&host=${INSTANCE_NAME}&_down_remove=Remove"
  only:
    - master
  when: on_success
  allow_failure: false

test_prod:
  stage: test
  image: node
  before_script:
    - apt update > /dev/null 2>&1 
    - apt install dos2unix python3 python3-pip jq git unzip zip curl bash openssl wget rsync -y > /dev/null 2>&1
    - DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends tzdata > /dev/null 2>&1
    - rm -rf /etc/localtime
    - ln -s /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime
    - date
    - curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - unzip -q awscliv2.zip
    - ./aws/install
    - aws --version
    - DATE=$(date +%d-%m-%YH%H:%M:%S)
    - echo $DATE
    - 'which ssh-agent || ( apt-get install -qq openssh-client )'
    - eval $(ssh-agent -s)
    # Setup SSH deploy keys
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    - export AWS_ACCESS_KEY_ID="${PROD_AWS_ACCESS_KEY_ID}"
    - export AWS_SECRET_ACCESS_KEY="${PROD_AWS_SECRET_ACCESS_KEY}"
  script:
    - echo "Buscando servidor do servico $CI_PROJECT_NAME no ambiente prod"
    - INSTANCE_NAME=$(aws ec2 describe-instances --region $AWS_DEFAULT_REGION --filters "Name=tag:Name,Values=$CI_PROJECT_NAME*" --query 'Reservations[*].Instances[*].{Name:Tags[?Key==`Name`]|[0].Value,PrivateIP:PrivateIpAddress}' | jq '.[] | .[] | .Name')
    - INSTANCE_NAME=`echo $INSTANCE_NAME | cut -d '"' -f2`
    - SERVER_IP=$(aws ec2 describe-instances --region $AWS_DEFAULT_REGION --filters "Name=tag:Name,Values=$CI_PROJECT_NAME*" --query 'Reservations[*].Instances[*].{Name:Tags[?Key==`Name`]|[0].Value,PrivateIP:PrivateIpAddress}' | jq '.[] | .[] | .PrivateIP')
    - SERVER_IP=`echo $SERVER_IP | cut -d '"' -f2`
    - echo "Listando processos em execução para o projeto $CI_PROJECT_NAME no ambiente prod"
    - ssh ubuntu@$SERVER_IP "export PATH=$PATH:/usr/local/nvm/versions/node/v10.14.1/bin; pm2 show '${CI_PROJECT_NAME}'"
    - echo "Verificando resposta do healthcheck localhost"
    - ssh ubuntu@$SERVER_IP "curl -s -I -X GET http://localhost:5000/api/v1/health"
    - echo "Verificando status code do healthcheck localhost"
    - curl -s -I -X GET http://$SERVER_IP:5000/api/v1/health
    - STATUS_CODE=`curl -s -I -X GET http://$SERVER_IP:5000/api/v1/health | grep HTTP | awk '{print $2}'`
    - echo $STATUS_CODE
    - >
            if [[ "$STATUS_CODE" == "200" ]]; 
            then 
                echo "O aplicativo '${CI_PROJECT_NAME}' esta esta respondendo status code  $STATUS_CODE"
                exit 0
            else 
                echo "O aplicativo '${CI_PROJECT_NAME}' esta esta respondendo status code de error  $STATUS_CODE"
                exit 1
            fi
  only:
    - master
  when: on_success
  allow_failure: true
